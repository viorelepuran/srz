{"version":3,"names":["_reactNative","require","_compose","_element","_data","_styles","_interopRequireDefault","_bottomSheet","_bottomSheetContext","_jsxRuntime","PER_PAGE","REQUEST_DEBOUNCE_DELAY","MINIMUM_QUERY_SIZE","meetsThreshold","query","length","LinkPickerResults","onLinkPicked","directEntry","links","setLinks","useState","hasAllSuggestions","setHasAllSuggestions","nextPage","useRef","pendingRequest","clearRequest","current","fetchMoreSuggestions","useSelect","select","getSettings","fetchLinkSuggestions","search","__experimentalFetchLinkSuggestions","page","type","perPage","fetchMore","currentSuggestions","request","suggestions","debounce","useEffect","onEndReached","spinner","jsx","View","style","styles","testID","children","ActivityIndicator","animating","BottomSheetConsumer","listProps","FlatList","data","keyboardShouldPersistTaps","renderItem","item","default","LinkSuggestionItemCell","suggestion","keyExtractor","url","onEndReachedThreshold","initialNumToRender","ListFooterComponent","contentContainerStyle","list"],"sources":["@wordpress/components/src/mobile/link-picker/link-picker-results.native.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { ActivityIndicator, FlatList, View } from 'react-native';\n\n/**\n * WordPress dependencies\n */\nimport { debounce } from '@wordpress/compose';\nimport { useState, useEffect, useRef } from '@wordpress/element';\nimport { useSelect } from '@wordpress/data';\n\n/**\n * Internal dependencies\n */\nimport styles from './styles.scss';\nimport BottomSheet from '../bottom-sheet';\nimport { BottomSheetConsumer } from '../bottom-sheet/bottom-sheet-context';\n\nconst PER_PAGE = 20;\nconst REQUEST_DEBOUNCE_DELAY = 400;\nconst MINIMUM_QUERY_SIZE = 2;\nconst meetsThreshold = ( query ) => MINIMUM_QUERY_SIZE <= query.length;\n\nexport default function LinkPickerResults( {\n\tquery,\n\tonLinkPicked,\n\tdirectEntry,\n} ) {\n\tconst [ links, setLinks ] = useState( [ directEntry ] );\n\tconst [ hasAllSuggestions, setHasAllSuggestions ] = useState( false );\n\tconst nextPage = useRef( 1 );\n\tconst pendingRequest = useRef();\n\tconst clearRequest = () => {\n\t\tpendingRequest.current = null;\n\t};\n\n\t// A stable debounced function to fetch suggestions and append.\n\tconst { fetchMoreSuggestions } = useSelect( ( select ) => {\n\t\tconst { getSettings } = select( 'core/block-editor' );\n\t\tconst fetchLinkSuggestions = async ( { search } ) => {\n\t\t\tif ( meetsThreshold( search ) ) {\n\t\t\t\treturn await getSettings().__experimentalFetchLinkSuggestions(\n\t\t\t\t\tsearch,\n\t\t\t\t\t{ page: nextPage.current, type: 'post', perPage: PER_PAGE }\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t\tconst fetchMore = async ( {\n\t\t\tquery: search,\n\t\t\tlinks: currentSuggestions,\n\t\t} ) => {\n\t\t\t// Return early if we've already detected the end of data or we are\n\t\t\t// already awaiting a response.\n\t\t\tif ( hasAllSuggestions || pendingRequest.current ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst request = fetchLinkSuggestions( { search } );\n\t\t\tpendingRequest.current = request;\n\t\t\tconst suggestions = await request;\n\n\t\t\t// Only update links for the most recent request.\n\t\t\tif ( suggestions && request === pendingRequest.current ) {\n\t\t\t\t// Since we don't have the response header, we check if the results\n\t\t\t\t// are truncated to determine we've reached the end.\n\t\t\t\tif ( suggestions.length < PER_PAGE ) {\n\t\t\t\t\tsetHasAllSuggestions( true );\n\t\t\t\t}\n\t\t\t\tsetLinks( [ ...currentSuggestions, ...suggestions ] );\n\t\t\t\tnextPage.current++;\n\t\t\t}\n\n\t\t\tclearRequest();\n\t\t};\n\t\treturn {\n\t\t\tfetchMoreSuggestions: debounce( fetchMore, REQUEST_DEBOUNCE_DELAY ),\n\t\t};\n\t\t// Not adding dependencies for now, to avoid introducing a regression\n\t\t// (see https://github.com/WordPress/gutenberg/pull/23922#discussion_r1170634879).\n\t}, [] );\n\n\t// Prevent setting state when unmounted.\n\tuseEffect( () => clearRequest, [] );\n\n\t// Any time the query changes, we reset pagination.\n\tuseEffect( () => {\n\t\tclearRequest();\n\t\tnextPage.current = 1;\n\t\tsetHasAllSuggestions( false );\n\t\tsetLinks( [ directEntry ] );\n\t\tfetchMoreSuggestions( { query, links: [ directEntry ] } );\n\t\t// See https://github.com/WordPress/gutenberg/pull/41166\n\t}, [ query ] );\n\n\tconst onEndReached = () => fetchMoreSuggestions( { query, links } );\n\n\tconst spinner = ! hasAllSuggestions && meetsThreshold( query ) && (\n\t\t<View style={ styles.spinner } testID=\"link-picker-loading\">\n\t\t\t<ActivityIndicator animating />\n\t\t</View>\n\t);\n\n\treturn (\n\t\t<BottomSheetConsumer>\n\t\t\t{ ( { listProps } ) => (\n\t\t\t\t<FlatList\n\t\t\t\t\tdata={ links }\n\t\t\t\t\tkeyboardShouldPersistTaps=\"always\"\n\t\t\t\t\trenderItem={ ( { item } ) => (\n\t\t\t\t\t\t<BottomSheet.LinkSuggestionItemCell\n\t\t\t\t\t\t\tsuggestion={ item }\n\t\t\t\t\t\t\tonLinkPicked={ onLinkPicked }\n\t\t\t\t\t\t/>\n\t\t\t\t\t) }\n\t\t\t\t\tkeyExtractor={ ( { url, type } ) => `${ url }-${ type }` }\n\t\t\t\t\tonEndReached={ onEndReached }\n\t\t\t\t\tonEndReachedThreshold={ 0.1 }\n\t\t\t\t\tinitialNumToRender={ PER_PAGE }\n\t\t\t\t\tListFooterComponent={ spinner }\n\t\t\t\t\t{ ...listProps }\n\t\t\t\t\tcontentContainerStyle={ [\n\t\t\t\t\t\t...listProps.contentContainerStyle,\n\t\t\t\t\t\tstyles.list,\n\t\t\t\t\t] }\n\t\t\t\t/>\n\t\t\t) }\n\t\t</BottomSheetConsumer>\n\t);\n}\n"],"mappings":"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","ignoreList":[]}