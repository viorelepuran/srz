{"version":3,"names":["_yWebrtc","require","cryptoutils","_interopRequireWildcard","map","_observable","buffer","_url","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","setupSignalEventHandlers","signalCon","url","on","log","topics","Array","from","rooms","keys","send","type","forEach","room","publishSignalingMessage","peerId","m","roomName","topic","undefined","execMessage","data","webrtcConns","to","bcConns","emitPeerChange","provider","emit","removed","added","webrtcPeers","bcPeers","size","maxConns","setIfUndefined","WebrtcConn","signal","existingConn","remoteToken","token","localToken","glareToken","peer","key","decryptJson","fromBase64","then","setupHttpSignal","httpClient","shouldConnect","ws","subscriberId","Math","floor","random","eventSource","window","EventSource","addQueryArgs","subscriber_id","action","pingTimeout","onmessage","event","lastMessageReceived","Date","now","messages","JSON","parse","isArray","onSingleMessage","connecting","connected","message","clearTimeout","setTimeout","sendPing","messageReconnectTimeout","onclose","error","close","unsuccessfulReconnects","readyState","OPEN","fetch","body","URLSearchParams","toString","method","catch","onerror","onopen","HttpSignalingConn","Observable","constructor","binaryType","_checkInterval","setInterval","providers","Set","stringify","destroy","clearInterval","disconnect","connect","exports","WebrtcProviderWithHttpSignaling","WebrtcProvider","signalingUrls","signalingConn","signalingConns","startsWith","SignalingConn","push","add"],"sources":["@wordpress/sync/src/webrtc-http-stream-signaling.js"],"sourcesContent":["/**\n * External dependencies\n */\n/**\n * Internal dependencies\n */\nimport {\n\tWebrtcProvider,\n\tSignalingConn,\n\tWebrtcConn,\n\tsignalingConns,\n\trooms,\n\tpublishSignalingMessage,\n\tlog,\n} from './y-webrtc/y-webrtc';\nimport * as cryptoutils from './y-webrtc/crypto';\n\nimport * as map from 'lib0/map';\nimport { Observable } from 'lib0/observable';\nimport * as buffer from 'lib0/buffer';\n\n/**\n * WordPress dependencies\n */\nimport { addQueryArgs } from '@wordpress/url';\n\n/**\n * Method copied as is from the SignalingConn constructor.\n * Setups the needed event handlers for an http signaling connection.\n *\n * @param {HttpSignalingConn} signalCon The signaling connection.\n * @param {string}            url       The url.\n */\nfunction setupSignalEventHandlers( signalCon, url ) {\n\tsignalCon.on( 'connect', () => {\n\t\tlog( `connected (${ url })` );\n\t\tconst topics = Array.from( rooms.keys() );\n\t\tsignalCon.send( { type: 'subscribe', topics } );\n\t\trooms.forEach( ( room ) =>\n\t\t\tpublishSignalingMessage( signalCon, room, {\n\t\t\t\ttype: 'announce',\n\t\t\t\tfrom: room.peerId,\n\t\t\t} )\n\t\t);\n\t} );\n\tsignalCon.on(\n\t\t'message',\n\t\t( /** @type {{ type: any; topic: any; data: string; }} */ m ) => {\n\t\t\tswitch ( m.type ) {\n\t\t\t\tcase 'publish': {\n\t\t\t\t\tconst roomName = m.topic;\n\t\t\t\t\tconst room = rooms.get( roomName );\n\t\t\t\t\tif (\n\t\t\t\t\t\troom === null ||\n\t\t\t\t\t\ttypeof roomName !== 'string' ||\n\t\t\t\t\t\troom === undefined\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst execMessage = ( /** @type {any} */ data ) => {\n\t\t\t\t\t\tconst webrtcConns = room.webrtcConns;\n\t\t\t\t\t\tconst peerId = room.peerId;\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tdata === null ||\n\t\t\t\t\t\t\tdata.from === peerId ||\n\t\t\t\t\t\t\t( data.to !== undefined && data.to !== peerId ) ||\n\t\t\t\t\t\t\troom.bcConns.has( data.from )\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t// ignore messages that are not addressed to this conn, or from clients that are connected via broadcastchannel\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst emitPeerChange = webrtcConns.has( data.from )\n\t\t\t\t\t\t\t? () => {}\n\t\t\t\t\t\t\t: () =>\n\t\t\t\t\t\t\t\t\troom.provider.emit( 'peers', [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tremoved: [],\n\t\t\t\t\t\t\t\t\t\t\tadded: [ data.from ],\n\t\t\t\t\t\t\t\t\t\t\twebrtcPeers: Array.from(\n\t\t\t\t\t\t\t\t\t\t\t\troom.webrtcConns.keys()\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\tbcPeers: Array.from( room.bcConns ),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t] );\n\t\t\t\t\t\tswitch ( data.type ) {\n\t\t\t\t\t\t\tcase 'announce':\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\twebrtcConns.size < room.provider.maxConns\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tsignalCon,\n\t\t\t\t\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'signal':\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'offer' ) {\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif ( existingConn ) {\n\t\t\t\t\t\t\t\t\t\tconst remoteToken = data.token;\n\t\t\t\t\t\t\t\t\t\tconst localToken =\n\t\t\t\t\t\t\t\t\t\t\texistingConn.glareToken;\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\tlocalToken &&\n\t\t\t\t\t\t\t\t\t\t\tlocalToken > remoteToken\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t\t\t\t\t\t'offer rejected: ',\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t// if we don't reject the offer, we will be accepting it and answering it\n\t\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'answer' ) {\n\t\t\t\t\t\t\t\t\tlog( 'offer answered by: ', data.from );\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif ( existingConn ) {\n\t\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.to === peerId ) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tsignalCon,\n\t\t\t\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t).peer.signal( data.signal );\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tif ( room.key ) {\n\t\t\t\t\t\tif ( typeof m.data === 'string' ) {\n\t\t\t\t\t\t\tcryptoutils\n\t\t\t\t\t\t\t\t.decryptJson(\n\t\t\t\t\t\t\t\t\tbuffer.fromBase64( m.data ),\n\t\t\t\t\t\t\t\t\troom.key\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.then( execMessage );\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\texecMessage( m.data );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t);\n\tsignalCon.on( 'disconnect', () => log( `disconnect (${ url })` ) );\n}\n\n/**\n * Method that instantiates the http signaling connection.\n * Tries to implement the same methods a websocket provides using ajax requests\n * to send messages and EventSource to retrieve messages.\n *\n * @param {HttpSignalingConn} httpClient The signaling connection.\n */\nfunction setupHttpSignal( httpClient ) {\n\tif ( httpClient.shouldConnect && httpClient.ws === null ) {\n\t\t// eslint-disable-next-line no-restricted-syntax\n\t\tconst subscriberId = Math.floor( 100000 + Math.random() * 900000 );\n\t\tconst url = httpClient.url;\n\t\tconst eventSource = new window.EventSource(\n\t\t\taddQueryArgs( url, {\n\t\t\t\tsubscriber_id: subscriberId,\n\t\t\t\taction: 'gutenberg_signaling_server',\n\t\t\t} )\n\t\t);\n\t\t/**\n\t\t * @type {any}\n\t\t */\n\t\tlet pingTimeout = null;\n\t\teventSource.onmessage = ( event ) => {\n\t\t\thttpClient.lastMessageReceived = Date.now();\n\t\t\tconst data = event.data;\n\t\t\tif ( data ) {\n\t\t\t\tconst messages = JSON.parse( data );\n\t\t\t\tif ( Array.isArray( messages ) ) {\n\t\t\t\t\tmessages.forEach( onSingleMessage );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t// @ts-ignore\n\t\thttpClient.ws = eventSource;\n\t\thttpClient.connecting = true;\n\t\thttpClient.connected = false;\n\t\tconst onSingleMessage = ( /** @type {any} */ message ) => {\n\t\t\tif ( message && message.type === 'pong' ) {\n\t\t\t\tclearTimeout( pingTimeout );\n\t\t\t\tpingTimeout = setTimeout(\n\t\t\t\t\tsendPing,\n\t\t\t\t\tmessageReconnectTimeout / 2\n\t\t\t\t);\n\t\t\t}\n\t\t\thttpClient.emit( 'message', [ message, httpClient ] );\n\t\t};\n\n\t\t/**\n\t\t * @param {any} error\n\t\t */\n\t\tconst onclose = ( error ) => {\n\t\t\tif ( httpClient.ws !== null ) {\n\t\t\t\thttpClient.ws.close();\n\t\t\t\thttpClient.ws = null;\n\t\t\t\thttpClient.connecting = false;\n\t\t\t\tif ( httpClient.connected ) {\n\t\t\t\t\thttpClient.connected = false;\n\t\t\t\t\thttpClient.emit( 'disconnect', [\n\t\t\t\t\t\t{ type: 'disconnect', error },\n\t\t\t\t\t\thttpClient,\n\t\t\t\t\t] );\n\t\t\t\t} else {\n\t\t\t\t\thttpClient.unsuccessfulReconnects++;\n\t\t\t\t}\n\t\t\t}\n\t\t\tclearTimeout( pingTimeout );\n\t\t};\n\t\tconst sendPing = () => {\n\t\t\tif (\n\t\t\t\thttpClient.ws &&\n\t\t\t\thttpClient.ws.readyState === window.EventSource.OPEN\n\t\t\t) {\n\t\t\t\thttpClient.send( {\n\t\t\t\t\ttype: 'ping',\n\t\t\t\t} );\n\t\t\t}\n\t\t};\n\t\tif ( httpClient.ws ) {\n\t\t\thttpClient.ws.onclose = () => {\n\t\t\t\tonclose( null );\n\t\t\t};\n\t\t\thttpClient.ws.send = function send(\n\t\t\t\t/** @type {string} */ message\n\t\t\t) {\n\t\t\t\twindow\n\t\t\t\t\t.fetch( url, {\n\t\t\t\t\t\tbody: new URLSearchParams( {\n\t\t\t\t\t\t\tsubscriber_id: subscriberId.toString(),\n\t\t\t\t\t\t\taction: 'gutenberg_signaling_server',\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t} ),\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t} )\n\t\t\t\t\t.catch( () => {\n\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t'Error sending to server with message: ' + message\n\t\t\t\t\t\t);\n\t\t\t\t\t} );\n\t\t\t};\n\t\t}\n\t\teventSource.onerror = () => {\n\t\t\t// Todo: add an error handler\n\t\t};\n\t\teventSource.onopen = () => {\n\t\t\tif ( httpClient.connected ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( eventSource.readyState === window.EventSource.OPEN ) {\n\t\t\t\thttpClient.lastMessageReceived = Date.now();\n\t\t\t\thttpClient.connecting = false;\n\t\t\t\thttpClient.connected = true;\n\t\t\t\thttpClient.unsuccessfulReconnects = 0;\n\t\t\t\thttpClient.emit( 'connect', [\n\t\t\t\t\t{ type: 'connect' },\n\t\t\t\t\thttpClient,\n\t\t\t\t] );\n\t\t\t\t// set ping\n\t\t\t\tpingTimeout = setTimeout(\n\t\t\t\t\tsendPing,\n\t\t\t\t\tmessageReconnectTimeout / 2\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n}\nconst messageReconnectTimeout = 30000;\n\n/**\n * @augments Observable<string>\n */ export class HttpSignalingConn extends Observable {\n\t/**\n\t * @param {string} url\n\t */\n\tconstructor( url ) {\n\t\tsuper();\n\n\t\t//WebsocketClient from lib0/websocket.js\n\t\tthis.url = url;\n\t\t/**\n\t\t * @type {WebSocket?}\n\t\t */\n\t\tthis.ws = null;\n\t\t// @ts-ignore\n\t\tthis.binaryType = null; // this.binaryType = binaryType\n\t\tthis.connected = false;\n\t\tthis.connecting = false;\n\t\tthis.unsuccessfulReconnects = 0;\n\t\tthis.lastMessageReceived = 0;\n\t\t/**\n\t\t * Whether to connect to other peers or not\n\t\t *\n\t\t * @type {boolean}\n\t\t */\n\t\tthis.shouldConnect = true;\n\t\tthis._checkInterval = setInterval( () => {\n\t\t\tif (\n\t\t\t\tthis.connected &&\n\t\t\t\tmessageReconnectTimeout <\n\t\t\t\t\tDate.now() - this.lastMessageReceived &&\n\t\t\t\tthis.ws\n\t\t\t) {\n\t\t\t\t// no message received in a long time - not even your own awareness\n\t\t\t\t// updates (which are updated every 15 seconds)\n\t\t\t\tthis.ws.close();\n\t\t\t}\n\t\t}, messageReconnectTimeout / 2 );\n\t\t//setupWS( this );\n\t\tsetupHttpSignal( this );\n\n\t\t// From SignalingConn\n\t\t/**\n\t\t * @type {Set<WebrtcProvider>}\n\t\t */\n\t\tthis.providers = new Set();\n\n\t\tsetupSignalEventHandlers( this, url );\n\t}\n\n\t/**\n\t * @param {any} message\n\t */\n\tsend( message ) {\n\t\tif ( this.ws ) {\n\t\t\tthis.ws.send( JSON.stringify( message ) );\n\t\t}\n\t}\n\n\tdestroy() {\n\t\tclearInterval( this._checkInterval );\n\t\tthis.disconnect();\n\t\tsuper.destroy();\n\t}\n\n\tdisconnect() {\n\t\tthis.shouldConnect = false;\n\t\tif ( this.ws !== null ) {\n\t\t\tthis.ws.close();\n\t\t}\n\t}\n\n\tconnect() {\n\t\tthis.shouldConnect = true;\n\t\tif ( ! this.connected && this.ws === null ) {\n\t\t\tsetupHttpSignal( this );\n\t\t}\n\t}\n}\n\nexport class WebrtcProviderWithHttpSignaling extends WebrtcProvider {\n\tconnect() {\n\t\tthis.shouldConnect = true;\n\t\tthis.signalingUrls.forEach( ( /** @type {string} */ url ) => {\n\t\t\tconst signalingConn = map.setIfUndefined(\n\t\t\t\tsignalingConns,\n\t\t\t\turl,\n\t\t\t\t// Only this conditional logic to create a normal websocket connection or\n\t\t\t\t// an http signaling connection was added to the constructor when compared\n\t\t\t\t// with the base class.\n\t\t\t\turl.startsWith( 'ws://' ) || url.startsWith( 'wss://' )\n\t\t\t\t\t? () => new SignalingConn( url )\n\t\t\t\t\t: () => new HttpSignalingConn( url )\n\t\t\t);\n\t\t\tthis.signalingConns.push( signalingConn );\n\t\t\tsignalingConn.providers.add( this );\n\t\t} );\n\t\tif ( this.room ) {\n\t\t\tthis.room.connect();\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]}