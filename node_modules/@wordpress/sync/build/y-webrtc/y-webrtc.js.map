{"version":3,"names":["ws","_interopRequireWildcard","require","map","error","random","encoding","decoding","_observable","logging","promise","bc","buffer","math","_mutex","Y","_simplepeerMin","_interopRequireDefault","syncProtocol","awarenessProtocol","cryptoutils","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","log","exports","createModuleLogger","messageSync","messageQueryAwareness","messageAwareness","messageBcPeerId","signalingConns","Map","rooms","checkIsSynced","room","synced","webrtcConns","forEach","peer","provider","emit","BOLD","name","UNBOLD","readMessage","buf","syncedCallback","decoder","createDecoder","encoder","createEncoder","messageType","readVarUint","undefined","awareness","doc","sendReply","writeVarUint","syncMessageType","readSyncMessage","messageYjsSyncStep2","messageYjsSyncStep1","writeVarUint8Array","encodeAwarenessUpdate","Array","from","getStates","keys","applyAwarenessUpdate","readVarUint8Array","add","readUint8","peerName","readVarString","peerId","bcConns","removed","added","push","delete","webrtcPeers","bcPeers","broadcastBcPeerId","console","readPeerMessage","peerConn","remotePeerId","GREY","UNCOLOR","sendWebrtcConn","webrtcConn","send","toUint8Array","broadcastWebrtcConn","m","conn","WebrtcConn","constructor","signalingConn","initiator","glareToken","closed","connected","Peer","peerOpts","on","signal","Date","now","Math","publishSignalingMessage","to","type","token","writeSyncStep1","awarenessStates","size","destroy","announceSignalingInfo","err","data","answer","broadcastBcMessage","encrypt","key","then","mux","publish","broadcastRoomMessage","bcconnected","topics","maxConns","filterBcConns","encoderPeerIdBc","writeUint8","writeVarString","Room","uuidv4","Set","createMutex","_bcSubscriber","decrypt","Uint8Array","reply","_docUpdateHandler","update","origin","writeUpdate","_awarenessUpdateHandler","updated","changedClients","concat","encoderAwareness","_beforeUnloadHandler","removeAwarenessStates","clientID","disconnect","window","addEventListener","process","connect","roomName","subscribe","encoderSync","encoderState","writeSyncStep2","encoderAwarenessQuery","encoderAwarenessState","unsubscribe","off","removeEventListener","openRoom","create","encryptJson","topic","toBase64","SignalingConn","WebsocketClient","url","providers","execMessage","emitPeerChange","setIfUndefined","existingConn","remoteToken","localToken","decryptJson","fromBase64","WebrtcProvider","Observable","signaling","password","Awareness","floor","rand","shouldConnect","signalingUrls","deriveKey","resolve","bind"],"sources":["@wordpress/sync/src/y-webrtc/y-webrtc.js"],"sourcesContent":["// File copied as is from the y-webrtc package with only exports\n// added to the following vars/functions: signalingConns,rooms, publishSignalingMessage, log.\n/* eslint-disable eslint-comments/disable-enable-pair */\n/* eslint-disable eslint-comments/no-unlimited-disable */\n/* eslint-disable */\n// @ts-nocheck\n\nimport * as ws from 'lib0/websocket';\nimport * as map from 'lib0/map';\nimport * as error from 'lib0/error';\nimport * as random from 'lib0/random';\nimport * as encoding from 'lib0/encoding';\nimport * as decoding from 'lib0/decoding';\nimport { Observable } from 'lib0/observable';\nimport * as logging from 'lib0/logging';\nimport * as promise from 'lib0/promise';\nimport * as bc from 'lib0/broadcastchannel';\nimport * as buffer from 'lib0/buffer';\nimport * as math from 'lib0/math';\nimport { createMutex } from 'lib0/mutex';\n\nimport * as Y from 'yjs'; // eslint-disable-line\nimport Peer from 'simple-peer/simplepeer.min.js';\n\nimport * as syncProtocol from 'y-protocols/sync';\nimport * as awarenessProtocol from 'y-protocols/awareness';\n\nimport * as cryptoutils from './crypto.js';\n\nexport const log = logging.createModuleLogger( 'y-webrtc' );\n\nconst messageSync = 0;\nconst messageQueryAwareness = 3;\nconst messageAwareness = 1;\nconst messageBcPeerId = 4;\n\n/**\n * @type {Map<string, SignalingConn>}\n */\nexport const signalingConns = new Map();\n\n/**\n * @type {Map<string,Room>}\n */\nexport const rooms = new Map();\n\n/**\n * @param {Room} room\n */\nconst checkIsSynced = ( room ) => {\n\tlet synced = true;\n\troom.webrtcConns.forEach( ( peer ) => {\n\t\tif ( ! peer.synced ) {\n\t\t\tsynced = false;\n\t\t}\n\t} );\n\tif ( ( ! synced && room.synced ) || ( synced && ! room.synced ) ) {\n\t\troom.synced = synced;\n\t\troom.provider.emit( 'synced', [ { synced } ] );\n\t\tlog(\n\t\t\t'synced ',\n\t\t\tlogging.BOLD,\n\t\t\troom.name,\n\t\t\tlogging.UNBOLD,\n\t\t\t' with all peers'\n\t\t);\n\t}\n};\n\n/**\n * @param {Room} room\n * @param {Uint8Array} buf\n * @param {function} syncedCallback\n * @return {encoding.Encoder?}\n */\nconst readMessage = ( room, buf, syncedCallback ) => {\n\tconst decoder = decoding.createDecoder( buf );\n\tconst encoder = encoding.createEncoder();\n\tconst messageType = decoding.readVarUint( decoder );\n\tif ( room === undefined ) {\n\t\treturn null;\n\t}\n\tconst awareness = room.awareness;\n\tconst doc = room.doc;\n\tlet sendReply = false;\n\tswitch ( messageType ) {\n\t\tcase messageSync: {\n\t\t\tencoding.writeVarUint( encoder, messageSync );\n\t\t\tconst syncMessageType = syncProtocol.readSyncMessage(\n\t\t\t\tdecoder,\n\t\t\t\tencoder,\n\t\t\t\tdoc,\n\t\t\t\troom\n\t\t\t);\n\t\t\tif (\n\t\t\t\tsyncMessageType === syncProtocol.messageYjsSyncStep2 &&\n\t\t\t\t! room.synced\n\t\t\t) {\n\t\t\t\tsyncedCallback();\n\t\t\t}\n\t\t\tif ( syncMessageType === syncProtocol.messageYjsSyncStep1 ) {\n\t\t\t\tsendReply = true;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase messageQueryAwareness:\n\t\t\tencoding.writeVarUint( encoder, messageAwareness );\n\t\t\tencoding.writeVarUint8Array(\n\t\t\t\tencoder,\n\t\t\t\tawarenessProtocol.encodeAwarenessUpdate(\n\t\t\t\t\tawareness,\n\t\t\t\t\tArray.from( awareness.getStates().keys() )\n\t\t\t\t)\n\t\t\t);\n\t\t\tsendReply = true;\n\t\t\tbreak;\n\t\tcase messageAwareness:\n\t\t\tawarenessProtocol.applyAwarenessUpdate(\n\t\t\t\tawareness,\n\t\t\t\tdecoding.readVarUint8Array( decoder ),\n\t\t\t\troom\n\t\t\t);\n\t\t\tbreak;\n\t\tcase messageBcPeerId: {\n\t\t\tconst add = decoding.readUint8( decoder ) === 1;\n\t\t\tconst peerName = decoding.readVarString( decoder );\n\t\t\tif (\n\t\t\t\tpeerName !== room.peerId &&\n\t\t\t\t( ( room.bcConns.has( peerName ) && ! add ) ||\n\t\t\t\t\t( ! room.bcConns.has( peerName ) && add ) )\n\t\t\t) {\n\t\t\t\tconst removed = [];\n\t\t\t\tconst added = [];\n\t\t\t\tif ( add ) {\n\t\t\t\t\troom.bcConns.add( peerName );\n\t\t\t\t\tadded.push( peerName );\n\t\t\t\t} else {\n\t\t\t\t\troom.bcConns.delete( peerName );\n\t\t\t\t\tremoved.push( peerName );\n\t\t\t\t}\n\t\t\t\troom.provider.emit( 'peers', [\n\t\t\t\t\t{\n\t\t\t\t\t\tadded,\n\t\t\t\t\t\tremoved,\n\t\t\t\t\t\twebrtcPeers: Array.from( room.webrtcConns.keys() ),\n\t\t\t\t\t\tbcPeers: Array.from( room.bcConns ),\n\t\t\t\t\t},\n\t\t\t\t] );\n\t\t\t\tbroadcastBcPeerId( room );\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tdefault:\n\t\t\tconsole.error( 'Unable to compute message' );\n\t\t\treturn encoder;\n\t}\n\tif ( ! sendReply ) {\n\t\t// nothing has been written, no answer created\n\t\treturn null;\n\t}\n\treturn encoder;\n};\n\n/**\n * @param {WebrtcConn} peerConn\n * @param {Uint8Array} buf\n * @return {encoding.Encoder?}\n */\nconst readPeerMessage = ( peerConn, buf ) => {\n\tconst room = peerConn.room;\n\tlog(\n\t\t'received message from ',\n\t\tlogging.BOLD,\n\t\tpeerConn.remotePeerId,\n\t\tlogging.GREY,\n\t\t' (',\n\t\troom.name,\n\t\t')',\n\t\tlogging.UNBOLD,\n\t\tlogging.UNCOLOR\n\t);\n\treturn readMessage( room, buf, () => {\n\t\tpeerConn.synced = true;\n\t\tlog(\n\t\t\t'synced ',\n\t\t\tlogging.BOLD,\n\t\t\troom.name,\n\t\t\tlogging.UNBOLD,\n\t\t\t' with ',\n\t\t\tlogging.BOLD,\n\t\t\tpeerConn.remotePeerId\n\t\t);\n\t\tcheckIsSynced( room );\n\t} );\n};\n\n/**\n * @param {WebrtcConn} webrtcConn\n * @param {encoding.Encoder} encoder\n */\nconst sendWebrtcConn = ( webrtcConn, encoder ) => {\n\tlog(\n\t\t'send message to ',\n\t\tlogging.BOLD,\n\t\twebrtcConn.remotePeerId,\n\t\tlogging.UNBOLD,\n\t\tlogging.GREY,\n\t\t' (',\n\t\twebrtcConn.room.name,\n\t\t')',\n\t\tlogging.UNCOLOR\n\t);\n\ttry {\n\t\twebrtcConn.peer.send( encoding.toUint8Array( encoder ) );\n\t} catch ( e ) {}\n};\n\n/**\n * @param {Room} room\n * @param {Uint8Array} m\n */\nconst broadcastWebrtcConn = ( room, m ) => {\n\tlog( 'broadcast message in ', logging.BOLD, room.name, logging.UNBOLD );\n\troom.webrtcConns.forEach( ( conn ) => {\n\t\ttry {\n\t\t\tconn.peer.send( m );\n\t\t} catch ( e ) {}\n\t} );\n};\n\nexport class WebrtcConn {\n\t/**\n\t * @param {SignalingConn} signalingConn\n\t * @param {boolean} initiator\n\t * @param {string} remotePeerId\n\t * @param {Room} room\n\t */\n\tconstructor( signalingConn, initiator, remotePeerId, room ) {\n\t\tlog( 'establishing connection to ', logging.BOLD, remotePeerId );\n\t\tthis.room = room;\n\t\tthis.remotePeerId = remotePeerId;\n\t\tthis.glareToken = undefined;\n\t\tthis.closed = false;\n\t\tthis.connected = false;\n\t\tthis.synced = false;\n\t\t/**\n\t\t * @type {any}\n\t\t */\n\t\tthis.peer = new Peer( { initiator, ...room.provider.peerOpts } );\n\t\tthis.peer.on( 'signal', ( signal ) => {\n\t\t\tif ( this.glareToken === undefined ) {\n\t\t\t\t// add some randomness to the timestamp of the offer\n\t\t\t\tthis.glareToken = Date.now() + Math.random();\n\t\t\t}\n\t\t\tpublishSignalingMessage( signalingConn, room, {\n\t\t\t\tto: remotePeerId,\n\t\t\t\tfrom: room.peerId,\n\t\t\t\ttype: 'signal',\n\t\t\t\ttoken: this.glareToken,\n\t\t\t\tsignal,\n\t\t\t} );\n\t\t} );\n\t\tthis.peer.on( 'connect', () => {\n\t\t\tlog( 'connected to ', logging.BOLD, remotePeerId );\n\t\t\tthis.connected = true;\n\t\t\t// send sync step 1\n\t\t\tconst provider = room.provider;\n\t\t\tconst doc = provider.doc;\n\t\t\tconst awareness = room.awareness;\n\t\t\tconst encoder = encoding.createEncoder();\n\t\t\tencoding.writeVarUint( encoder, messageSync );\n\t\t\tsyncProtocol.writeSyncStep1( encoder, doc );\n\t\t\tsendWebrtcConn( this, encoder );\n\t\t\tconst awarenessStates = awareness.getStates();\n\t\t\tif ( awarenessStates.size > 0 ) {\n\t\t\t\tconst encoder = encoding.createEncoder();\n\t\t\t\tencoding.writeVarUint( encoder, messageAwareness );\n\t\t\t\tencoding.writeVarUint8Array(\n\t\t\t\t\tencoder,\n\t\t\t\t\tawarenessProtocol.encodeAwarenessUpdate(\n\t\t\t\t\t\tawareness,\n\t\t\t\t\t\tArray.from( awarenessStates.keys() )\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tsendWebrtcConn( this, encoder );\n\t\t\t}\n\t\t} );\n\t\tthis.peer.on( 'close', () => {\n\t\t\tthis.connected = false;\n\t\t\tthis.closed = true;\n\t\t\tif ( room.webrtcConns.has( this.remotePeerId ) ) {\n\t\t\t\troom.webrtcConns.delete( this.remotePeerId );\n\t\t\t\troom.provider.emit( 'peers', [\n\t\t\t\t\t{\n\t\t\t\t\t\tremoved: [ this.remotePeerId ],\n\t\t\t\t\t\tadded: [],\n\t\t\t\t\t\twebrtcPeers: Array.from( room.webrtcConns.keys() ),\n\t\t\t\t\t\tbcPeers: Array.from( room.bcConns ),\n\t\t\t\t\t},\n\t\t\t\t] );\n\t\t\t}\n\t\t\tcheckIsSynced( room );\n\t\t\tthis.peer.destroy();\n\t\t\tlog( 'closed connection to ', logging.BOLD, remotePeerId );\n\t\t\tannounceSignalingInfo( room );\n\t\t} );\n\t\tthis.peer.on( 'error', ( err ) => {\n\t\t\tlog(\n\t\t\t\t'Error in connection to ',\n\t\t\t\tlogging.BOLD,\n\t\t\t\tremotePeerId,\n\t\t\t\t': ',\n\t\t\t\terr\n\t\t\t);\n\t\t\tannounceSignalingInfo( room );\n\t\t} );\n\t\tthis.peer.on( 'data', ( data ) => {\n\t\t\tconst answer = readPeerMessage( this, data );\n\t\t\tif ( answer !== null ) {\n\t\t\t\tsendWebrtcConn( this, answer );\n\t\t\t}\n\t\t} );\n\t}\n\n\tdestroy() {\n\t\tthis.peer.destroy();\n\t}\n}\n\n/**\n * @param {Room} room\n * @param {Uint8Array} m\n */\nconst broadcastBcMessage = ( room, m ) =>\n\tcryptoutils\n\t\t.encrypt( m, room.key )\n\t\t.then( ( data ) => room.mux( () => bc.publish( room.name, data ) ) );\n\n/**\n * @param {Room} room\n * @param {Uint8Array} m\n */\nconst broadcastRoomMessage = ( room, m ) => {\n\tif ( room.bcconnected ) {\n\t\tbroadcastBcMessage( room, m );\n\t}\n\tbroadcastWebrtcConn( room, m );\n};\n\n/**\n * @param {Room} room\n */\nconst announceSignalingInfo = ( room ) => {\n\tsignalingConns.forEach( ( conn ) => {\n\t\t// only subscribe if connection is established, otherwise the conn automatically subscribes to all rooms\n\t\tif ( conn.connected ) {\n\t\t\tconn.send( { type: 'subscribe', topics: [ room.name ] } );\n\t\t\tif ( room.webrtcConns.size < room.provider.maxConns ) {\n\t\t\t\tpublishSignalingMessage( conn, room, {\n\t\t\t\t\ttype: 'announce',\n\t\t\t\t\tfrom: room.peerId,\n\t\t\t\t} );\n\t\t\t}\n\t\t}\n\t} );\n};\n\n/**\n * @param {Room} room\n */\nconst broadcastBcPeerId = ( room ) => {\n\tif ( room.provider.filterBcConns ) {\n\t\t// broadcast peerId via broadcastchannel\n\t\tconst encoderPeerIdBc = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderPeerIdBc, messageBcPeerId );\n\t\tencoding.writeUint8( encoderPeerIdBc, 1 );\n\t\tencoding.writeVarString( encoderPeerIdBc, room.peerId );\n\t\tbroadcastBcMessage( room, encoding.toUint8Array( encoderPeerIdBc ) );\n\t}\n};\n\nexport class Room {\n\t/**\n\t * @param {Y.Doc} doc\n\t * @param {WebrtcProvider} provider\n\t * @param {string} name\n\t * @param {CryptoKey|null} key\n\t */\n\tconstructor( doc, provider, name, key ) {\n\t\t/**\n\t\t * Do not assume that peerId is unique. This is only meant for sending signaling messages.\n\t\t *\n\t\t * @type {string}\n\t\t */\n\t\tthis.peerId = random.uuidv4();\n\t\tthis.doc = doc;\n\t\t/**\n\t\t * @type {awarenessProtocol.Awareness}\n\t\t */\n\t\tthis.awareness = provider.awareness;\n\t\tthis.provider = provider;\n\t\tthis.synced = false;\n\t\tthis.name = name;\n\t\t// @todo make key secret by scoping\n\t\tthis.key = key;\n\t\t/**\n\t\t * @type {Map<string, WebrtcConn>}\n\t\t */\n\t\tthis.webrtcConns = new Map();\n\t\t/**\n\t\t * @type {Set<string>}\n\t\t */\n\t\tthis.bcConns = new Set();\n\t\tthis.mux = createMutex();\n\t\tthis.bcconnected = false;\n\t\t/**\n\t\t * @param {ArrayBuffer} data\n\t\t */\n\t\tthis._bcSubscriber = ( data ) =>\n\t\t\tcryptoutils.decrypt( new Uint8Array( data ), key ).then( ( m ) =>\n\t\t\t\tthis.mux( () => {\n\t\t\t\t\tconst reply = readMessage( this, m, () => {} );\n\t\t\t\t\tif ( reply ) {\n\t\t\t\t\t\tbroadcastBcMessage(\n\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\tencoding.toUint8Array( reply )\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t} )\n\t\t\t);\n\t\t/**\n\t\t * Listens to Yjs updates and sends them to remote peers\n\t\t *\n\t\t * @param {Uint8Array} update\n\t\t * @param {any} origin\n\t\t */\n\t\tthis._docUpdateHandler = ( update, origin ) => {\n\t\t\tconst encoder = encoding.createEncoder();\n\t\t\tencoding.writeVarUint( encoder, messageSync );\n\t\t\tsyncProtocol.writeUpdate( encoder, update );\n\t\t\tbroadcastRoomMessage( this, encoding.toUint8Array( encoder ) );\n\t\t};\n\t\t/**\n\t\t * Listens to Awareness updates and sends them to remote peers\n\t\t *\n\t\t * @param {any} changed\n\t\t * @param {any} origin\n\t\t */\n\t\tthis._awarenessUpdateHandler = (\n\t\t\t{ added, updated, removed },\n\t\t\torigin\n\t\t) => {\n\t\t\tconst changedClients = added.concat( updated ).concat( removed );\n\t\t\tconst encoderAwareness = encoding.createEncoder();\n\t\t\tencoding.writeVarUint( encoderAwareness, messageAwareness );\n\t\t\tencoding.writeVarUint8Array(\n\t\t\t\tencoderAwareness,\n\t\t\t\tawarenessProtocol.encodeAwarenessUpdate(\n\t\t\t\t\tthis.awareness,\n\t\t\t\t\tchangedClients\n\t\t\t\t)\n\t\t\t);\n\t\t\tbroadcastRoomMessage(\n\t\t\t\tthis,\n\t\t\t\tencoding.toUint8Array( encoderAwareness )\n\t\t\t);\n\t\t};\n\n\t\tthis._beforeUnloadHandler = () => {\n\t\t\tawarenessProtocol.removeAwarenessStates(\n\t\t\t\tthis.awareness,\n\t\t\t\t[ doc.clientID ],\n\t\t\t\t'window unload'\n\t\t\t);\n\t\t\trooms.forEach( ( room ) => {\n\t\t\t\troom.disconnect();\n\t\t\t} );\n\t\t};\n\n\t\tif ( typeof window !== 'undefined' ) {\n\t\t\twindow.addEventListener(\n\t\t\t\t'beforeunload',\n\t\t\t\tthis._beforeUnloadHandler\n\t\t\t);\n\t\t} else if ( typeof process !== 'undefined' ) {\n\t\t\tprocess.on( 'exit', this._beforeUnloadHandler );\n\t\t}\n\t}\n\n\tconnect() {\n\t\tthis.doc.on( 'update', this._docUpdateHandler );\n\t\tthis.awareness.on( 'update', this._awarenessUpdateHandler );\n\t\t// signal through all available signaling connections\n\t\tannounceSignalingInfo( this );\n\t\tconst roomName = this.name;\n\t\tbc.subscribe( roomName, this._bcSubscriber );\n\t\tthis.bcconnected = true;\n\t\t// broadcast peerId via broadcastchannel\n\t\tbroadcastBcPeerId( this );\n\t\t// write sync step 1\n\t\tconst encoderSync = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderSync, messageSync );\n\t\tsyncProtocol.writeSyncStep1( encoderSync, this.doc );\n\t\tbroadcastBcMessage( this, encoding.toUint8Array( encoderSync ) );\n\t\t// broadcast local state\n\t\tconst encoderState = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderState, messageSync );\n\t\tsyncProtocol.writeSyncStep2( encoderState, this.doc );\n\t\tbroadcastBcMessage( this, encoding.toUint8Array( encoderState ) );\n\t\t// write queryAwareness\n\t\tconst encoderAwarenessQuery = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderAwarenessQuery, messageQueryAwareness );\n\t\tbroadcastBcMessage(\n\t\t\tthis,\n\t\t\tencoding.toUint8Array( encoderAwarenessQuery )\n\t\t);\n\t\t// broadcast local awareness state\n\t\tconst encoderAwarenessState = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderAwarenessState, messageAwareness );\n\t\tencoding.writeVarUint8Array(\n\t\t\tencoderAwarenessState,\n\t\t\tawarenessProtocol.encodeAwarenessUpdate( this.awareness, [\n\t\t\t\tthis.doc.clientID,\n\t\t\t] )\n\t\t);\n\t\tbroadcastBcMessage(\n\t\t\tthis,\n\t\t\tencoding.toUint8Array( encoderAwarenessState )\n\t\t);\n\t}\n\n\tdisconnect() {\n\t\t// signal through all available signaling connections\n\t\tsignalingConns.forEach( ( conn ) => {\n\t\t\tif ( conn.connected ) {\n\t\t\t\tconn.send( { type: 'unsubscribe', topics: [ this.name ] } );\n\t\t\t}\n\t\t} );\n\t\tawarenessProtocol.removeAwarenessStates(\n\t\t\tthis.awareness,\n\t\t\t[ this.doc.clientID ],\n\t\t\t'disconnect'\n\t\t);\n\t\t// broadcast peerId removal via broadcastchannel\n\t\tconst encoderPeerIdBc = encoding.createEncoder();\n\t\tencoding.writeVarUint( encoderPeerIdBc, messageBcPeerId );\n\t\tencoding.writeUint8( encoderPeerIdBc, 0 ); // remove peerId from other bc peers\n\t\tencoding.writeVarString( encoderPeerIdBc, this.peerId );\n\t\tbroadcastBcMessage( this, encoding.toUint8Array( encoderPeerIdBc ) );\n\n\t\tbc.unsubscribe( this.name, this._bcSubscriber );\n\t\tthis.bcconnected = false;\n\t\tthis.doc.off( 'update', this._docUpdateHandler );\n\t\tthis.awareness.off( 'update', this._awarenessUpdateHandler );\n\t\tthis.webrtcConns.forEach( ( conn ) => conn.destroy() );\n\t}\n\n\tdestroy() {\n\t\tthis.disconnect();\n\t\tif ( typeof window !== 'undefined' ) {\n\t\t\twindow.removeEventListener(\n\t\t\t\t'beforeunload',\n\t\t\t\tthis._beforeUnloadHandler\n\t\t\t);\n\t\t} else if ( typeof process !== 'undefined' ) {\n\t\t\tprocess.off( 'exit', this._beforeUnloadHandler );\n\t\t}\n\t}\n}\n\n/**\n * @param {Y.Doc} doc\n * @param {WebrtcProvider} provider\n * @param {string} name\n * @param {CryptoKey|null} key\n * @return {Room}\n */\nconst openRoom = ( doc, provider, name, key ) => {\n\t// there must only be one room\n\tif ( rooms.has( name ) ) {\n\t\tthrow error.create(\n\t\t\t`A Yjs Doc connected to room \"${ name }\" already exists!`\n\t\t);\n\t}\n\tconst room = new Room( doc, provider, name, key );\n\trooms.set( name, /** @type {Room} */ ( room ) );\n\treturn room;\n};\n\n/**\n * @param {SignalingConn} conn\n * @param {Room} room\n * @param {any} data\n */\nexport const publishSignalingMessage = ( conn, room, data ) => {\n\tif ( room.key ) {\n\t\tcryptoutils.encryptJson( data, room.key ).then( ( data ) => {\n\t\t\tconn.send( {\n\t\t\t\ttype: 'publish',\n\t\t\t\ttopic: room.name,\n\t\t\t\tdata: buffer.toBase64( data ),\n\t\t\t} );\n\t\t} );\n\t} else {\n\t\tconn.send( { type: 'publish', topic: room.name, data } );\n\t}\n};\n\nexport class SignalingConn extends ws.WebsocketClient {\n\tconstructor( url ) {\n\t\tsuper( url );\n\t\t/**\n\t\t * @type {Set<WebrtcProvider>}\n\t\t */\n\t\tthis.providers = new Set();\n\t\tthis.on( 'connect', () => {\n\t\t\tlog( `connected (${ url })` );\n\t\t\tconst topics = Array.from( rooms.keys() );\n\t\t\tthis.send( { type: 'subscribe', topics } );\n\t\t\trooms.forEach( ( room ) =>\n\t\t\t\tpublishSignalingMessage( this, room, {\n\t\t\t\t\ttype: 'announce',\n\t\t\t\t\tfrom: room.peerId,\n\t\t\t\t} )\n\t\t\t);\n\t\t} );\n\t\tthis.on( 'message', ( m ) => {\n\t\t\tswitch ( m.type ) {\n\t\t\t\tcase 'publish': {\n\t\t\t\t\tconst roomName = m.topic;\n\t\t\t\t\tconst room = rooms.get( roomName );\n\t\t\t\t\tif ( room == null || typeof roomName !== 'string' ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst execMessage = ( data ) => {\n\t\t\t\t\t\tconst webrtcConns = room.webrtcConns;\n\t\t\t\t\t\tconst peerId = room.peerId;\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tdata == null ||\n\t\t\t\t\t\t\tdata.from === peerId ||\n\t\t\t\t\t\t\t( data.to !== undefined && data.to !== peerId ) ||\n\t\t\t\t\t\t\troom.bcConns.has( data.from )\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t// ignore messages that are not addressed to this conn, or from clients that are connected via broadcastchannel\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst emitPeerChange = webrtcConns.has( data.from )\n\t\t\t\t\t\t\t? () => {}\n\t\t\t\t\t\t\t: () =>\n\t\t\t\t\t\t\t\t\troom.provider.emit( 'peers', [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tremoved: [],\n\t\t\t\t\t\t\t\t\t\t\tadded: [ data.from ],\n\t\t\t\t\t\t\t\t\t\t\twebrtcPeers: Array.from(\n\t\t\t\t\t\t\t\t\t\t\t\troom.webrtcConns.keys()\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\tbcPeers: Array.from( room.bcConns ),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t] );\n\t\t\t\t\t\tswitch ( data.type ) {\n\t\t\t\t\t\t\tcase 'announce':\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\twebrtcConns.size < room.provider.maxConns\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'signal':\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'offer' ) {\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif ( existingConn ) {\n\t\t\t\t\t\t\t\t\t\tconst remoteToken = data.token;\n\t\t\t\t\t\t\t\t\t\tconst localToken =\n\t\t\t\t\t\t\t\t\t\t\texistingConn.glareToken;\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\tlocalToken &&\n\t\t\t\t\t\t\t\t\t\t\tlocalToken > remoteToken\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t\t\t\t\t\t'offer rejected: ',\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t// if we don't reject the offer, we will be accepting it and answering it\n\t\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'answer' ) {\n\t\t\t\t\t\t\t\t\tlog( 'offer answered by: ', data.from );\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.to === peerId ) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t).peer.signal( data.signal );\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tif ( room.key ) {\n\t\t\t\t\t\tif ( typeof m.data === 'string' ) {\n\t\t\t\t\t\t\tcryptoutils\n\t\t\t\t\t\t\t\t.decryptJson(\n\t\t\t\t\t\t\t\t\tbuffer.fromBase64( m.data ),\n\t\t\t\t\t\t\t\t\troom.key\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.then( execMessage );\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\texecMessage( m.data );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t\tthis.on( 'disconnect', () => log( `disconnect (${ url })` ) );\n\t}\n}\n\n/**\n * @typedef {Object} ProviderOptions\n * @property {Array<string>} [signaling]\n * @property {string} [password]\n * @property {awarenessProtocol.Awareness} [awareness]\n * @property {number} [maxConns]\n * @property {boolean} [filterBcConns]\n * @property {any} [peerOpts]\n */\n\n/**\n * @extends Observable<string>\n */\nexport class WebrtcProvider extends Observable {\n\t/**\n\t * @param {string} roomName\n\t * @param {Y.Doc} doc\n\t * @param {ProviderOptions?} opts\n\t */\n\tconstructor(\n\t\troomName,\n\t\tdoc,\n\t\t{\n\t\t\tsignaling = [ 'wss://y-webrtc-eu.fly.dev' ],\n\t\t\tpassword = null,\n\t\t\tawareness = new awarenessProtocol.Awareness( doc ),\n\t\t\tmaxConns = 20 + math.floor( random.rand() * 15 ), // the random factor reduces the chance that n clients form a cluster\n\t\t\tfilterBcConns = true,\n\t\t\tpeerOpts = {}, // simple-peer options. See https://github.com/feross/simple-peer#peer--new-peeropts\n\t\t} = {}\n\t) {\n\t\tsuper();\n\t\tthis.roomName = roomName;\n\t\tthis.doc = doc;\n\t\tthis.filterBcConns = filterBcConns;\n\t\t/**\n\t\t * @type {awarenessProtocol.Awareness}\n\t\t */\n\t\tthis.awareness = awareness;\n\t\tthis.shouldConnect = false;\n\t\tthis.signalingUrls = signaling;\n\t\tthis.signalingConns = [];\n\t\tthis.maxConns = maxConns;\n\t\tthis.peerOpts = peerOpts;\n\t\t/**\n\t\t * @type {PromiseLike<CryptoKey | null>}\n\t\t */\n\t\tthis.key = password\n\t\t\t? cryptoutils.deriveKey( password, roomName )\n\t\t\t: /** @type {PromiseLike<null>} */ ( promise.resolve( null ) );\n\t\t/**\n\t\t * @type {Room|null}\n\t\t */\n\t\tthis.room = null;\n\t\tthis.key.then( ( key ) => {\n\t\t\tthis.room = openRoom( doc, this, roomName, key );\n\t\t\tif ( this.shouldConnect ) {\n\t\t\t\tthis.room.connect();\n\t\t\t} else {\n\t\t\t\tthis.room.disconnect();\n\t\t\t}\n\t\t} );\n\t\tthis.connect();\n\t\tthis.destroy = this.destroy.bind( this );\n\t\tdoc.on( 'destroy', this.destroy );\n\t}\n\n\t/**\n\t * @type {boolean}\n\t */\n\tget connected() {\n\t\treturn this.room !== null && this.shouldConnect;\n\t}\n\n\tconnect() {\n\t\tthis.shouldConnect = true;\n\t\tthis.signalingUrls.forEach( ( url ) => {\n\t\t\tconst signalingConn = map.setIfUndefined(\n\t\t\t\tsignalingConns,\n\t\t\t\turl,\n\t\t\t\t() => new SignalingConn( url )\n\t\t\t);\n\t\t\tthis.signalingConns.push( signalingConn );\n\t\t\tsignalingConn.providers.add( this );\n\t\t} );\n\t\tif ( this.room ) {\n\t\t\tthis.room.connect();\n\t\t}\n\t}\n\n\tdisconnect() {\n\t\tthis.shouldConnect = false;\n\t\tthis.signalingConns.forEach( ( conn ) => {\n\t\t\tconn.providers.delete( this );\n\t\t\tif ( conn.providers.size === 0 ) {\n\t\t\t\tconn.destroy();\n\t\t\t\tsignalingConns.delete( conn.url );\n\t\t\t}\n\t\t} );\n\t\tif ( this.room ) {\n\t\t\tthis.room.disconnect();\n\t\t}\n\t}\n\n\tdestroy() {\n\t\tthis.doc.off( 'destroy', this.destroy );\n\t\t// need to wait for key before deleting room\n\t\tthis.key.then( () => {\n\t\t\t/** @type {Room} */ ( this.room ).destroy();\n\t\t\trooms.delete( this.roomName );\n\t\t} );\n\t\tsuper.destroy();\n\t}\n}\n"],"mappings":"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","ignoreList":[]}