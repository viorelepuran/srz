{"version":3,"names":["WebrtcProvider","SignalingConn","WebrtcConn","signalingConns","rooms","publishSignalingMessage","log","cryptoutils","map","Observable","buffer","addQueryArgs","setupSignalEventHandlers","signalCon","url","on","topics","Array","from","keys","send","type","forEach","room","peerId","m","roomName","topic","get","undefined","execMessage","data","webrtcConns","to","bcConns","has","emitPeerChange","provider","emit","removed","added","webrtcPeers","bcPeers","size","maxConns","setIfUndefined","signal","existingConn","remoteToken","token","localToken","glareToken","peer","key","decryptJson","fromBase64","then","setupHttpSignal","httpClient","shouldConnect","ws","subscriberId","Math","floor","random","eventSource","window","EventSource","subscriber_id","action","pingTimeout","onmessage","event","lastMessageReceived","Date","now","messages","JSON","parse","isArray","onSingleMessage","connecting","connected","message","clearTimeout","setTimeout","sendPing","messageReconnectTimeout","onclose","error","close","unsuccessfulReconnects","readyState","OPEN","fetch","body","URLSearchParams","toString","method","catch","onerror","onopen","HttpSignalingConn","constructor","binaryType","_checkInterval","setInterval","providers","Set","stringify","destroy","clearInterval","disconnect","connect","WebrtcProviderWithHttpSignaling","signalingUrls","signalingConn","startsWith","push","add"],"sources":["@wordpress/sync/src/webrtc-http-stream-signaling.js"],"sourcesContent":["/**\n * External dependencies\n */\n/**\n * Internal dependencies\n */\nimport {\n\tWebrtcProvider,\n\tSignalingConn,\n\tWebrtcConn,\n\tsignalingConns,\n\trooms,\n\tpublishSignalingMessage,\n\tlog,\n} from './y-webrtc/y-webrtc';\nimport * as cryptoutils from './y-webrtc/crypto';\n\nimport * as map from 'lib0/map';\nimport { Observable } from 'lib0/observable';\nimport * as buffer from 'lib0/buffer';\n\n/**\n * WordPress dependencies\n */\nimport { addQueryArgs } from '@wordpress/url';\n\n/**\n * Method copied as is from the SignalingConn constructor.\n * Setups the needed event handlers for an http signaling connection.\n *\n * @param {HttpSignalingConn} signalCon The signaling connection.\n * @param {string}            url       The url.\n */\nfunction setupSignalEventHandlers( signalCon, url ) {\n\tsignalCon.on( 'connect', () => {\n\t\tlog( `connected (${ url })` );\n\t\tconst topics = Array.from( rooms.keys() );\n\t\tsignalCon.send( { type: 'subscribe', topics } );\n\t\trooms.forEach( ( room ) =>\n\t\t\tpublishSignalingMessage( signalCon, room, {\n\t\t\t\ttype: 'announce',\n\t\t\t\tfrom: room.peerId,\n\t\t\t} )\n\t\t);\n\t} );\n\tsignalCon.on(\n\t\t'message',\n\t\t( /** @type {{ type: any; topic: any; data: string; }} */ m ) => {\n\t\t\tswitch ( m.type ) {\n\t\t\t\tcase 'publish': {\n\t\t\t\t\tconst roomName = m.topic;\n\t\t\t\t\tconst room = rooms.get( roomName );\n\t\t\t\t\tif (\n\t\t\t\t\t\troom === null ||\n\t\t\t\t\t\ttypeof roomName !== 'string' ||\n\t\t\t\t\t\troom === undefined\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst execMessage = ( /** @type {any} */ data ) => {\n\t\t\t\t\t\tconst webrtcConns = room.webrtcConns;\n\t\t\t\t\t\tconst peerId = room.peerId;\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tdata === null ||\n\t\t\t\t\t\t\tdata.from === peerId ||\n\t\t\t\t\t\t\t( data.to !== undefined && data.to !== peerId ) ||\n\t\t\t\t\t\t\troom.bcConns.has( data.from )\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t// ignore messages that are not addressed to this conn, or from clients that are connected via broadcastchannel\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst emitPeerChange = webrtcConns.has( data.from )\n\t\t\t\t\t\t\t? () => {}\n\t\t\t\t\t\t\t: () =>\n\t\t\t\t\t\t\t\t\troom.provider.emit( 'peers', [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tremoved: [],\n\t\t\t\t\t\t\t\t\t\t\tadded: [ data.from ],\n\t\t\t\t\t\t\t\t\t\t\twebrtcPeers: Array.from(\n\t\t\t\t\t\t\t\t\t\t\t\troom.webrtcConns.keys()\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\tbcPeers: Array.from( room.bcConns ),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t] );\n\t\t\t\t\t\tswitch ( data.type ) {\n\t\t\t\t\t\t\tcase 'announce':\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\twebrtcConns.size < room.provider.maxConns\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tsignalCon,\n\t\t\t\t\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'signal':\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'offer' ) {\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif ( existingConn ) {\n\t\t\t\t\t\t\t\t\t\tconst remoteToken = data.token;\n\t\t\t\t\t\t\t\t\t\tconst localToken =\n\t\t\t\t\t\t\t\t\t\t\texistingConn.glareToken;\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\tlocalToken &&\n\t\t\t\t\t\t\t\t\t\t\tlocalToken > remoteToken\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t\t\t\t\t\t'offer rejected: ',\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t// if we don't reject the offer, we will be accepting it and answering it\n\t\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.signal.type === 'answer' ) {\n\t\t\t\t\t\t\t\t\tlog( 'offer answered by: ', data.from );\n\t\t\t\t\t\t\t\t\tconst existingConn = webrtcConns.get(\n\t\t\t\t\t\t\t\t\t\tdata.from\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif ( existingConn ) {\n\t\t\t\t\t\t\t\t\t\texistingConn.glareToken = undefined;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( data.to === peerId ) {\n\t\t\t\t\t\t\t\t\tmap.setIfUndefined(\n\t\t\t\t\t\t\t\t\t\twebrtcConns,\n\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t() =>\n\t\t\t\t\t\t\t\t\t\t\tnew WebrtcConn(\n\t\t\t\t\t\t\t\t\t\t\t\tsignalCon,\n\t\t\t\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t\t\t\tdata.from,\n\t\t\t\t\t\t\t\t\t\t\t\troom\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t).peer.signal( data.signal );\n\t\t\t\t\t\t\t\t\temitPeerChange();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tif ( room.key ) {\n\t\t\t\t\t\tif ( typeof m.data === 'string' ) {\n\t\t\t\t\t\t\tcryptoutils\n\t\t\t\t\t\t\t\t.decryptJson(\n\t\t\t\t\t\t\t\t\tbuffer.fromBase64( m.data ),\n\t\t\t\t\t\t\t\t\troom.key\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.then( execMessage );\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\texecMessage( m.data );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t);\n\tsignalCon.on( 'disconnect', () => log( `disconnect (${ url })` ) );\n}\n\n/**\n * Method that instantiates the http signaling connection.\n * Tries to implement the same methods a websocket provides using ajax requests\n * to send messages and EventSource to retrieve messages.\n *\n * @param {HttpSignalingConn} httpClient The signaling connection.\n */\nfunction setupHttpSignal( httpClient ) {\n\tif ( httpClient.shouldConnect && httpClient.ws === null ) {\n\t\t// eslint-disable-next-line no-restricted-syntax\n\t\tconst subscriberId = Math.floor( 100000 + Math.random() * 900000 );\n\t\tconst url = httpClient.url;\n\t\tconst eventSource = new window.EventSource(\n\t\t\taddQueryArgs( url, {\n\t\t\t\tsubscriber_id: subscriberId,\n\t\t\t\taction: 'gutenberg_signaling_server',\n\t\t\t} )\n\t\t);\n\t\t/**\n\t\t * @type {any}\n\t\t */\n\t\tlet pingTimeout = null;\n\t\teventSource.onmessage = ( event ) => {\n\t\t\thttpClient.lastMessageReceived = Date.now();\n\t\t\tconst data = event.data;\n\t\t\tif ( data ) {\n\t\t\t\tconst messages = JSON.parse( data );\n\t\t\t\tif ( Array.isArray( messages ) ) {\n\t\t\t\t\tmessages.forEach( onSingleMessage );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t// @ts-ignore\n\t\thttpClient.ws = eventSource;\n\t\thttpClient.connecting = true;\n\t\thttpClient.connected = false;\n\t\tconst onSingleMessage = ( /** @type {any} */ message ) => {\n\t\t\tif ( message && message.type === 'pong' ) {\n\t\t\t\tclearTimeout( pingTimeout );\n\t\t\t\tpingTimeout = setTimeout(\n\t\t\t\t\tsendPing,\n\t\t\t\t\tmessageReconnectTimeout / 2\n\t\t\t\t);\n\t\t\t}\n\t\t\thttpClient.emit( 'message', [ message, httpClient ] );\n\t\t};\n\n\t\t/**\n\t\t * @param {any} error\n\t\t */\n\t\tconst onclose = ( error ) => {\n\t\t\tif ( httpClient.ws !== null ) {\n\t\t\t\thttpClient.ws.close();\n\t\t\t\thttpClient.ws = null;\n\t\t\t\thttpClient.connecting = false;\n\t\t\t\tif ( httpClient.connected ) {\n\t\t\t\t\thttpClient.connected = false;\n\t\t\t\t\thttpClient.emit( 'disconnect', [\n\t\t\t\t\t\t{ type: 'disconnect', error },\n\t\t\t\t\t\thttpClient,\n\t\t\t\t\t] );\n\t\t\t\t} else {\n\t\t\t\t\thttpClient.unsuccessfulReconnects++;\n\t\t\t\t}\n\t\t\t}\n\t\t\tclearTimeout( pingTimeout );\n\t\t};\n\t\tconst sendPing = () => {\n\t\t\tif (\n\t\t\t\thttpClient.ws &&\n\t\t\t\thttpClient.ws.readyState === window.EventSource.OPEN\n\t\t\t) {\n\t\t\t\thttpClient.send( {\n\t\t\t\t\ttype: 'ping',\n\t\t\t\t} );\n\t\t\t}\n\t\t};\n\t\tif ( httpClient.ws ) {\n\t\t\thttpClient.ws.onclose = () => {\n\t\t\t\tonclose( null );\n\t\t\t};\n\t\t\thttpClient.ws.send = function send(\n\t\t\t\t/** @type {string} */ message\n\t\t\t) {\n\t\t\t\twindow\n\t\t\t\t\t.fetch( url, {\n\t\t\t\t\t\tbody: new URLSearchParams( {\n\t\t\t\t\t\t\tsubscriber_id: subscriberId.toString(),\n\t\t\t\t\t\t\taction: 'gutenberg_signaling_server',\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t} ),\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t} )\n\t\t\t\t\t.catch( () => {\n\t\t\t\t\t\tlog(\n\t\t\t\t\t\t\t'Error sending to server with message: ' + message\n\t\t\t\t\t\t);\n\t\t\t\t\t} );\n\t\t\t};\n\t\t}\n\t\teventSource.onerror = () => {\n\t\t\t// Todo: add an error handler\n\t\t};\n\t\teventSource.onopen = () => {\n\t\t\tif ( httpClient.connected ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( eventSource.readyState === window.EventSource.OPEN ) {\n\t\t\t\thttpClient.lastMessageReceived = Date.now();\n\t\t\t\thttpClient.connecting = false;\n\t\t\t\thttpClient.connected = true;\n\t\t\t\thttpClient.unsuccessfulReconnects = 0;\n\t\t\t\thttpClient.emit( 'connect', [\n\t\t\t\t\t{ type: 'connect' },\n\t\t\t\t\thttpClient,\n\t\t\t\t] );\n\t\t\t\t// set ping\n\t\t\t\tpingTimeout = setTimeout(\n\t\t\t\t\tsendPing,\n\t\t\t\t\tmessageReconnectTimeout / 2\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n}\nconst messageReconnectTimeout = 30000;\n\n/**\n * @augments Observable<string>\n */ export class HttpSignalingConn extends Observable {\n\t/**\n\t * @param {string} url\n\t */\n\tconstructor( url ) {\n\t\tsuper();\n\n\t\t//WebsocketClient from lib0/websocket.js\n\t\tthis.url = url;\n\t\t/**\n\t\t * @type {WebSocket?}\n\t\t */\n\t\tthis.ws = null;\n\t\t// @ts-ignore\n\t\tthis.binaryType = null; // this.binaryType = binaryType\n\t\tthis.connected = false;\n\t\tthis.connecting = false;\n\t\tthis.unsuccessfulReconnects = 0;\n\t\tthis.lastMessageReceived = 0;\n\t\t/**\n\t\t * Whether to connect to other peers or not\n\t\t *\n\t\t * @type {boolean}\n\t\t */\n\t\tthis.shouldConnect = true;\n\t\tthis._checkInterval = setInterval( () => {\n\t\t\tif (\n\t\t\t\tthis.connected &&\n\t\t\t\tmessageReconnectTimeout <\n\t\t\t\t\tDate.now() - this.lastMessageReceived &&\n\t\t\t\tthis.ws\n\t\t\t) {\n\t\t\t\t// no message received in a long time - not even your own awareness\n\t\t\t\t// updates (which are updated every 15 seconds)\n\t\t\t\tthis.ws.close();\n\t\t\t}\n\t\t}, messageReconnectTimeout / 2 );\n\t\t//setupWS( this );\n\t\tsetupHttpSignal( this );\n\n\t\t// From SignalingConn\n\t\t/**\n\t\t * @type {Set<WebrtcProvider>}\n\t\t */\n\t\tthis.providers = new Set();\n\n\t\tsetupSignalEventHandlers( this, url );\n\t}\n\n\t/**\n\t * @param {any} message\n\t */\n\tsend( message ) {\n\t\tif ( this.ws ) {\n\t\t\tthis.ws.send( JSON.stringify( message ) );\n\t\t}\n\t}\n\n\tdestroy() {\n\t\tclearInterval( this._checkInterval );\n\t\tthis.disconnect();\n\t\tsuper.destroy();\n\t}\n\n\tdisconnect() {\n\t\tthis.shouldConnect = false;\n\t\tif ( this.ws !== null ) {\n\t\t\tthis.ws.close();\n\t\t}\n\t}\n\n\tconnect() {\n\t\tthis.shouldConnect = true;\n\t\tif ( ! this.connected && this.ws === null ) {\n\t\t\tsetupHttpSignal( this );\n\t\t}\n\t}\n}\n\nexport class WebrtcProviderWithHttpSignaling extends WebrtcProvider {\n\tconnect() {\n\t\tthis.shouldConnect = true;\n\t\tthis.signalingUrls.forEach( ( /** @type {string} */ url ) => {\n\t\t\tconst signalingConn = map.setIfUndefined(\n\t\t\t\tsignalingConns,\n\t\t\t\turl,\n\t\t\t\t// Only this conditional logic to create a normal websocket connection or\n\t\t\t\t// an http signaling connection was added to the constructor when compared\n\t\t\t\t// with the base class.\n\t\t\t\turl.startsWith( 'ws://' ) || url.startsWith( 'wss://' )\n\t\t\t\t\t? () => new SignalingConn( url )\n\t\t\t\t\t: () => new HttpSignalingConn( url )\n\t\t\t);\n\t\t\tthis.signalingConns.push( signalingConn );\n\t\t\tsignalingConn.providers.add( this );\n\t\t} );\n\t\tif ( this.room ) {\n\t\t\tthis.room.connect();\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]}