{"version":3,"names":["Y","createSyncProvider","connectLocal","connectRemote","config","listeners","docs","register","objectType","objectConfig","bootstrap","objectId","handleChanges","doc","Doc","updateHandler","data","fromCRDTDoc","on","destroyLocalConnection","loadRemotely","fetch","then","transact","applyChangesToDoc","off","update","discard"],"sources":["@wordpress/sync/src/provider.js"],"sourcesContent":["/**\n * External dependencies\n */\n// @ts-ignore\nimport * as Y from 'yjs';\n\n/** @typedef {import('./types').ObjectType} ObjectType */\n/** @typedef {import('./types').ObjectID} ObjectID */\n/** @typedef {import('./types').ObjectConfig} ObjectConfig */\n/** @typedef {import('./types').CRDTDoc} CRDTDoc */\n/** @typedef {import('./types').ConnectDoc} ConnectDoc */\n/** @typedef {import('./types').SyncProvider} SyncProvider */\n\n/**\n * Create a sync provider.\n *\n * @param {ConnectDoc} connectLocal  Connect the document to a local database.\n * @param {ConnectDoc} connectRemote Connect the document to a remote sync connection.\n * @return {SyncProvider} Sync provider.\n */\nexport const createSyncProvider = ( connectLocal, connectRemote ) => {\n\t/**\n\t * @type {Record<string,ObjectConfig>}\n\t */\n\tconst config = {};\n\n\t/**\n\t * @type {Record<string,Record<string,()=>void>>}\n\t */\n\tconst listeners = {};\n\n\t/**\n\t * @type {Record<string,Record<string,CRDTDoc>>}\n\t */\n\tconst docs = {};\n\n\t/**\n\t * Registers an object type.\n\t *\n\t * @param {ObjectType}   objectType   Object type to register.\n\t * @param {ObjectConfig} objectConfig Object config.\n\t */\n\tfunction register( objectType, objectConfig ) {\n\t\tconfig[ objectType ] = objectConfig;\n\t}\n\n\t/**\n\t * Fetch data from local database or remote source.\n\t *\n\t * @param {ObjectType} objectType    Object type to load.\n\t * @param {ObjectID}   objectId      Object ID to load.\n\t * @param {Function}   handleChanges Callback to call when data changes.\n\t */\n\tasync function bootstrap( objectType, objectId, handleChanges ) {\n\t\tconst doc = new Y.Doc();\n\t\tdocs[ objectType ] = docs[ objectType ] || {};\n\t\tdocs[ objectType ][ objectId ] = doc;\n\n\t\tconst updateHandler = () => {\n\t\t\tconst data = config[ objectType ].fromCRDTDoc( doc );\n\t\t\thandleChanges( data );\n\t\t};\n\t\tdoc.on( 'update', updateHandler );\n\n\t\t// connect to locally saved database.\n\t\tconst destroyLocalConnection = await connectLocal(\n\t\t\tobjectId,\n\t\t\tobjectType,\n\t\t\tdoc\n\t\t);\n\n\t\t// Once the database syncing is done, start the remote syncing\n\t\tif ( connectRemote ) {\n\t\t\tawait connectRemote( objectId, objectType, doc );\n\t\t}\n\n\t\tconst loadRemotely = config[ objectType ].fetch;\n\t\tif ( loadRemotely ) {\n\t\t\tloadRemotely( objectId ).then( ( data ) => {\n\t\t\t\tdoc.transact( () => {\n\t\t\t\t\tconfig[ objectType ].applyChangesToDoc( doc, data );\n\t\t\t\t} );\n\t\t\t} );\n\t\t}\n\n\t\tlisteners[ objectType ] = listeners[ objectType ] || {};\n\t\tlisteners[ objectType ][ objectId ] = () => {\n\t\t\tdestroyLocalConnection();\n\t\t\tdoc.off( 'update', updateHandler );\n\t\t};\n\t}\n\n\t/**\n\t * Fetch data from local database or remote source.\n\t *\n\t * @param {ObjectType} objectType Object type to load.\n\t * @param {ObjectID}   objectId   Object ID to load.\n\t * @param {any}        data       Updates to make.\n\t */\n\tasync function update( objectType, objectId, data ) {\n\t\tconst doc = docs[ objectType ][ objectId ];\n\t\tif ( ! doc ) {\n\t\t\tthrow 'Error doc ' + objectType + ' ' + objectId + ' not found';\n\t\t}\n\t\tdoc.transact( () => {\n\t\t\tconfig[ objectType ].applyChangesToDoc( doc, data );\n\t\t} );\n\t}\n\n\t/**\n\t * Stop updating a document and discard it.\n\t *\n\t * @param {ObjectType} objectType Object type to load.\n\t * @param {ObjectID}   objectId   Object ID to load.\n\t */\n\tasync function discard( objectType, objectId ) {\n\t\tif ( listeners?.[ objectType ]?.[ objectId ] ) {\n\t\t\tlisteners[ objectType ][ objectId ]();\n\t\t}\n\t}\n\n\treturn {\n\t\tregister,\n\t\tbootstrap,\n\t\tupdate,\n\t\tdiscard,\n\t};\n};\n"],"mappings":"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","ignoreList":[]}