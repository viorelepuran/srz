{"version":3,"names":["_apiFetch","_interopRequireDefault","require","_data","_element","_i18n","_notices","_dom","messages","crop","__","rotate","cropAndRotate","useSaveImage","rotation","url","id","onSaveImage","onFinishEditing","createErrorNotice","createSuccessNotice","useDispatch","noticesStore","isInProgress","setIsInProgress","useState","cancel","useCallback","apply","modifiers","push","type","args","angle","width","height","left","x","top","y","length","modifierType","apiFetch","path","method","data","src","then","response","source_url","actions","label","onClick","catch","error","sprintf","stripHTML","message","finally","useMemo"],"sources":["@wordpress/block-editor/src/components/image-editor/use-save-image.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\n// Disable Reason: Needs to be refactored.\n// eslint-disable-next-line no-restricted-imports\nimport apiFetch from '@wordpress/api-fetch';\nimport { useDispatch } from '@wordpress/data';\nimport { useCallback, useMemo, useState } from '@wordpress/element';\nimport { __, sprintf } from '@wordpress/i18n';\nimport { store as noticesStore } from '@wordpress/notices';\nimport { __unstableStripHTML as stripHTML } from '@wordpress/dom';\n\nconst messages = {\n\tcrop: __( 'Image cropped.' ),\n\trotate: __( 'Image rotated.' ),\n\tcropAndRotate: __( 'Image cropped and rotated.' ),\n};\n\nexport default function useSaveImage( {\n\tcrop,\n\trotation,\n\turl,\n\tid,\n\tonSaveImage,\n\tonFinishEditing,\n} ) {\n\tconst { createErrorNotice, createSuccessNotice } =\n\t\tuseDispatch( noticesStore );\n\tconst [ isInProgress, setIsInProgress ] = useState( false );\n\n\tconst cancel = useCallback( () => {\n\t\tsetIsInProgress( false );\n\t\tonFinishEditing();\n\t}, [ onFinishEditing ] );\n\n\tconst apply = useCallback( () => {\n\t\tsetIsInProgress( true );\n\n\t\tconst modifiers = [];\n\n\t\tif ( rotation > 0 ) {\n\t\t\tmodifiers.push( {\n\t\t\t\ttype: 'rotate',\n\t\t\t\targs: {\n\t\t\t\t\tangle: rotation,\n\t\t\t\t},\n\t\t\t} );\n\t\t}\n\n\t\t// The crop script may return some very small, sub-pixel values when the image was not cropped.\n\t\t// Crop only when the new size has changed by more than 0.1%.\n\t\tif ( crop.width < 99.9 || crop.height < 99.9 ) {\n\t\t\tmodifiers.push( {\n\t\t\t\ttype: 'crop',\n\t\t\t\targs: {\n\t\t\t\t\tleft: crop.x,\n\t\t\t\t\ttop: crop.y,\n\t\t\t\t\twidth: crop.width,\n\t\t\t\t\theight: crop.height,\n\t\t\t\t},\n\t\t\t} );\n\t\t}\n\n\t\tif ( modifiers.length === 0 ) {\n\t\t\t// No changes to apply.\n\t\t\tsetIsInProgress( false );\n\t\t\tonFinishEditing();\n\t\t\treturn;\n\t\t}\n\n\t\tconst modifierType =\n\t\t\tmodifiers.length === 1 ? modifiers[ 0 ].type : 'cropAndRotate';\n\n\t\tapiFetch( {\n\t\t\tpath: `/wp/v2/media/${ id }/edit`,\n\t\t\tmethod: 'POST',\n\t\t\tdata: { src: url, modifiers },\n\t\t} )\n\t\t\t.then( ( response ) => {\n\t\t\t\tonSaveImage( {\n\t\t\t\t\tid: response.id,\n\t\t\t\t\turl: response.source_url,\n\t\t\t\t} );\n\t\t\t\tcreateSuccessNotice( messages[ modifierType ], {\n\t\t\t\t\ttype: 'snackbar',\n\t\t\t\t\tactions: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: __( 'Undo' ),\n\t\t\t\t\t\t\tonClick: () => {\n\t\t\t\t\t\t\t\tonSaveImage( {\n\t\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t} );\n\t\t\t} )\n\t\t\t.catch( ( error ) => {\n\t\t\t\tcreateErrorNotice(\n\t\t\t\t\tsprintf(\n\t\t\t\t\t\t/* translators: %s: Error message. */\n\t\t\t\t\t\t__( 'Could not edit image. %s' ),\n\t\t\t\t\t\tstripHTML( error.message )\n\t\t\t\t\t),\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'image-editing-error',\n\t\t\t\t\t\ttype: 'snackbar',\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t} )\n\t\t\t.finally( () => {\n\t\t\t\tsetIsInProgress( false );\n\t\t\t\tonFinishEditing();\n\t\t\t} );\n\t}, [\n\t\tcrop,\n\t\trotation,\n\t\tid,\n\t\turl,\n\t\tonSaveImage,\n\t\tcreateErrorNotice,\n\t\tcreateSuccessNotice,\n\t\tonFinishEditing,\n\t] );\n\n\treturn useMemo(\n\t\t() => ( {\n\t\t\tisInProgress,\n\t\t\tapply,\n\t\t\tcancel,\n\t\t} ),\n\t\t[ isInProgress, apply, cancel ]\n\t);\n}\n"],"mappings":"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","ignoreList":[]}